version: '3'

tasks:
  # â›“ ĞĞ±Ñ‰Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
  mkdir-security-dir:
    internal: true
    cmds:
      - mkdir -p security

  # âœ… Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
  security-all:
    desc: âœ… Run all security tools
    cmds:
      - task: gosec
      - task: osv-scanner
      - task: semgrep
      - task: trivy
      - task: gitleaks
      - task: trufflehog

  # ğŸ”’ Gosec
  gosec:
    desc: ğŸ”’ Run gosec
    cmds:
      - task: mkdir-security-dir
      - gosec -quiet -fmt=json -out=security/gosec-report.json ./...

  # ğŸ§ª OSV-Scanner
  osv-scanner:
    desc: ğŸ§ª osv-scanner
    cmds:
      - task: mkdir-security-dir
      - osv-scanner --lockfile=go.sum --format=json > security/osv-report.json || true

  # ğŸ“ Semgrep
  semgrep:
    desc: ğŸ“ semgrep
    cmds:
      - task: mkdir-security-dir
      - semgrep scan --config=auto --json > security/semgrep-report.json || true

  # ğŸ›¡ï¸ Trivy
  trivy:
    desc: ğŸ›¡ï¸ trivy
    cmds:
      - task: mkdir-security-dir
      - trivy config --timeout 5m --format json --output security/trivy-config.json .
      - trivy fs . --scanners vuln,secret,misconfig --format json --output security/trivy-fs.json || true

  # ğŸ” Gitleaks
  gitleaks:
    desc: ğŸ” gitleaks
    cmds:
      - task: mkdir-security-dir
      - gitleaks detect --source $(pwd) --no-git --redact --report-format sarif --report-path security/gitleaks-report.sarif || true

  # ğŸ TruffleHog
  trufflehog:
    desc: ğŸ trufflehog
    cmds:
      - task: mkdir-security-dir
      - trufflehog git --repo_path=$(pwd) --json > security/trufflehog.json || true

  # ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° CLI
  build-cli:
    desc: ğŸ”§ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° CLI...
    cmds:
      - echo "ğŸ”§ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° CLI..."
      - mkdir -p bin
      - go build -o bin/secretly ./cmd/secretly

  # ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°
  build-server:
    desc: ğŸ”§ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°...
    cmds:
      - echo "ğŸ”§ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°..."
      - mkdir -p bin
      - go build -o bin/server ./server

  # ğŸ—ï¸ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° secret CLI
  build-secret:
    desc: ğŸ”§ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° secret...
    cmds:
      - echo "ğŸ”§ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° secret..."
      - mkdir -p bin
      - go build -o bin/secret ./cmd/secret

  # ğŸ”¨ ĞĞ±Ñ‰Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°
  build:
    desc: ğŸ› ï¸ Run security checks and build all components
    cmds:
      - echo "ğŸ” Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²ÑĞµ security-Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸..."
      - task: security-all
      - echo "ğŸ› ï¸ Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹..."
      - task: build-cli
      - task: build-server
      - task: build-secret